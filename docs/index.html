<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Johan Hidding" />
  <title>Chaotic pendulum</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="css/bootstrap.css" />
  <link rel="stylesheet" href="css/mods.css" />
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
<!-- <script data-main="scripts/main" src="js/require.js"></script> -->
  <!-- Load React. -->
  <!-- Note: when deploying, replace "development.js" with "production.min.js". -->
<!--  <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script> -->


</head>
<body>

<nav id="TOC" class="navbar navbar-dark bg-dark">
  <a href="#" class="navbar-brand">Chaotic pendulum<br><span style="font-size: smaller">a literate programming demo by <i>Johan Hidding</i></span></a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
<div class="collapse navbar-collapse" id="navbarSupportedContent">
<ul>
<li><a href="#why-we-care">Why we care</a></li>
<li><a href="#todo">TODO</a></li>
<li><a href="#the-pendulum">The pendulum</a></li>
<li><a href="#leap-frog-method">Leap-frog method</a><ul>
<li><a href="#integrating-the-single-pendulum">Integrating the single pendulum</a></li>
</ul></li>
<li><a href="#the-double-pendulum">The double pendulum</a></li>
<li><a href="#animation-using-flare">Animation using Flare</a><ul>
<li><a href="#flare">Flare</a></li>
<li><a href="#drawing">Drawing</a></li>
<li><a href="#main">Main</a></li>
</ul></li>
</ul>
</div>
</nav>

<!-- <nav class="navbar navbar-dark navbar-expand-md bg-dark mb-4">
<p class="subtitle">a literate programming demo</p>
<p class="author">Johan Hidding</p>
</nav>
 -->

<main role="main" class="container"><div class="container">
<p><span class="math inline">\(\renewcommand{\vec}[1]{{\bf #1}}\)</span></p>
<div class="container-fluid">
<div class="row">
<div class="col">
<div class="card h-100">
<div class="card-body">
<h3 class="card-title">Literate Programming</h3>
<div class="card-text">
<p>Write prose and code intermixed. Not just some choice snippets: <strong>all code is included!</strong> This document is a rendering of a completely <strong>self-contained Markdown</strong> file.</p>
</div>
</div>
<a href="https://entangled.github.io" class="btn btn-primary mt-auto mx-4">About Entangled</a>
</div>
</div>
<div class="col">
<div class="card h-100">
<div class="card-body">
<h3 class="card-title">Build with Pandoc</h3>
<div class="card-text">
<p>Pandoc is the <strong>universal document converter</strong>. This demo is converted from Markdown to a responsive Bootstrap website using Pandoc.</p>
</div>
</div>
<a href="https://pandoc.org/" class="btn btn-primary mt-auto mx-4">About Pandoc</a>
</div>
</div>
<div class="col">
<div class="card h-100">
<div class="card-body">
<h3 class="card-title">Strongly typed Physics</h3>
<div class="card-text">
<p>This demonstrates some <strong>strongly typed physics</strong>, combining Hamiltonian dynamics with the elegant type system of PureScript.</p>
</div>
</div>
<a href="https://www.purescript.org/" class="btn btn-primary mt-auto mx-4">About PureScript</a>
</div>
</div>
</div>
</div>
<hr />
<div class="container-fluid">
<div class="row">
<canvas class="col" id="double-pendulum-output" width="600" height="500" style="background: #eee; border-radius: 10px;">
</canvas>
<!-- <div id="double-pendulum-output"></div> -->
<div id="double-pendulum-control" class="col">

</div>
</div>
</div>
<hr />
<p>This demo shows an interactive model of the chaotic double pendulum, written in PureScript, using Pandoc and Entangled to create the static web page. The entire demo runs in your web browser, so unlike with Python or R no special server is needed, just host from Github pages! Since PureScript is not the most well known programming language, I will explain some details about the use of PureScript in a bit more detail. You can recognize these by their blue shade.</p>
<div class="alert alert-info">
<p>PureScript is a strongly typed functional language similar to Haskell that compiles to JavaScript. It has a highly formal approach to data types that matches really well with the topic of modelling dynamic systems.</p>
<p>Other than that, I have been able to build this demo without great knowledge of JavaScript.</p>
</div>
<p>I understand the danger of explaining two difficult things at once. Non-linear dynamics is a difficult topic and PureScript is a language with high levels of abstraction. I’m hoping you can cherry pick from this demo whatever you’re trying to learn.</p>
<h2 id="why-we-care">Why we care</h2>
<p>I’ve heard some rumours that people really like Jupyter notebooks and MyBinder. Rightly so! You can show your work to colleages around the world and they don’t have to setup anything. People can learn from what you have done because the code is right there! MyBinder has some problems though: it only works with languages that have a Jupyter kernel available. While there are kernels available for languages other than Python, Julia and R, outside those two your options are really limited especially in terms of visualisation. Also MyBinder has been getting slower due to large demands on a free service. The computations are being run on a remote server and one way or another, this costs money.</p>
<p>If you’re willing to learn JavaScript, there is the option of writing <a href="https://observablehq.com/">Observable notebooks</a>. Observable is great, but it requires you to work in JavaScript. Also, to my best knowledge Observable is not (yet) open source, so you’ll still be relying on an external service to work with your code.</p>
<p>Thirdly, you may not always want an interactive web environment to do your coding in. Coding is hard, and we got used to working with code, runtimes and debuggers from editors, consoles and IDEs. Why change all that? There is a solution where you can mix and match languages, write your story in one or more Markdown files, have your cake and eat it too! This setup is still under development, which is in part why I made this demo.</p>
<div class="container-fluid my-5">
<div class="row">
<div class="col">
<div class="jumbotron h-100">
<h3 id="get-to-see">Get to see</h3>
<ul>
<li>Experimental science blogging with live interactive demos</li>
<li>How to use Literate Programming to learn and teach</li>
<li>See a chaotic double pendulum in action</li>
</ul>
</div>
</div>
<div class="col">
<div class="jumbotron h-100">
<h3 id="get-to-learn">Get to learn</h3>
<ul>
<li>Learn some <a href="https://purescript.org">PureScript</a></li>
<li>See how we can call <a href="https://plotly.com">PlotLy</a> from PureScript</li>
<li>Use the PureScript <a href="https://github.com/sharkdp/purescript-flare">Flare library</a> to create interactive demos</li>
<li>Use Pandoc to create a static <a href="https://getbootstrap.com">Bootstrap</a> page</li>
<li>Use <a href="https://entangled.github.io">Entangled</a> for literate programming</li>
</ul>
</div>
</div>
</div>
</div>
<p>The physics used in this demo assumes some understanding of Lagrangian/Hamiltonian dynamics. We will first model the time evolution of a simple pendulum, and then extend our model to that of a double pendulum.</p>
<h2 id="todo">TODO</h2>
<ul>
<li>Reduce CPU usage when animation is not playing</li>
<li>Write pandoc filter for collapsable code cells</li>
<li>Add footer</li>
</ul>
<h1 id="the-pendulum">The pendulum</h1>
<p>It was found by Christiaan Huygens that a pendulum can make an excelent clock. We assume a solid massless rod suspending a weight of mass <span class="math inline">\(m\)</span> at a length <span class="math inline">\(l\)</span> from the origin. The Lagrangian for such a system (being <span class="math inline">\(\mathcal{L} = T - U\)</span>, where <span class="math inline">\(T\)</span> is the kinetic energy and <span class="math inline">\(U\)</span> is the potential energy) is written as</p>
<p><span class="math display">\[\mathcal{L}(\theta, \dot{\theta}) = \frac{1}{2}ml^2\dot{\theta}^2 + mgl \cos\theta.\]</span></p>
<p>Using the Euler-Lagrange equations, in very terse notation <span class="math inline">\(D_t \partial_{\dot{\theta}} \mathcal{L} = \partial_{\theta} \mathcal{L}\)</span>, leads to</p>
<p><span class="math display">\[\ddot{\theta} = -\frac{g}{l} \sin\theta.\]</span></p>
<p>This is a second order non-linear differential equation. To solve this numerically we write down the equation in phase-space using position <span class="math inline">\(\vec{q}(t) = \theta(t)\)</span> and momentum <span class="math inline">\(\vec{p}(t) = D_{\dot{\theta}} \mathcal{L} = ml^2\dot{\theta}(t)\)</span>. This is best done using the Hamiltonian formalism. The Hamiltonian becomes</p>
<p><span class="math display">\[\mathcal{H} = \frac{\vec{p}^2}{2ml^2} - mgl \cos \vec{q}.\]</span></p>
<p>Having <span class="math inline">\(\dot{\vec{p}} = - \partial_q \mathcal{H}\)</span> and <span class="math inline">\(\dot{\vec{q}} = + \partial_p \mathcal{H}\)</span>.</p>
<p><span class="math display">\[\begin{pmatrix}\dot{\vec{q}} \\ \dot{\vec{p}}\end{pmatrix} = \begin{pmatrix}\vec{p} / {ml^2} \\ -mgl \sin \vec{q}\end{pmatrix}.\]</span></p>
<p>In PureScript this system can be expressed as follows:</p>
<div class="annotated-code">
<p><span><em>«pendulum-model»=</em></span></p>
<div class="sourceCode" id="pendulum-model"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="pendulum-model-1" title="1"><span class="ot">simplePendulum </span><span class="fu">::</span> <span class="dt">Number</span> <span class="fu">-&gt;</span> <span class="dt">Number</span> <span class="fu">-&gt;</span> <span class="dt">HamiltonianSystem</span> <span class="dt">Scalar</span></a>
<a class="sourceLine" id="pendulum-model-2" title="2">simplePendulum g l <span class="fu">=</span></a>
<a class="sourceLine" id="pendulum-model-3" title="3">    { positionEquation<span class="fu">:</span> (\s <span class="fu">-&gt;</span> (\p <span class="fu">-&gt;</span> p <span class="fu">/</span> pow l <span class="dv">2.0</span>) <span class="fu">&lt;$&gt;</span> s<span class="fu">.</span>momentum)</a>
<a class="sourceLine" id="pendulum-model-4" title="4">    , momentumEquation<span class="fu">:</span> (\s <span class="fu">-&gt;</span> (\q <span class="fu">-&gt;</span> <span class="fu">-</span>g <span class="fu">*</span> l <span class="fu">*</span> (sin q)) <span class="fu">&lt;$&gt;</span> s<span class="fu">.</span>position)</a>
<a class="sourceLine" id="pendulum-model-5" title="5">    }</a></code></pre></div>
</div>
<div class="alert alert-info">
<p>The first line of this definition is the type declaration of the <code>simplePendulum</code> function: it takes a number (the gravitational accelleration) another number (the length of the pendulum) and returns a <code>HamiltonianSystem Scalar</code>, which is saying a Hamiltonian system of equations in one dimension. These types will be defined when we program the leap-frog integrator.</p>
</div>
<p>We are now going to compute the time evolution of the single pendulum using the leap-frog method.</p>
<h1 id="leap-frog-method">Leap-frog method</h1>
<p>We can describe this methods in terms of types in code. Later on, we will deal with systems of more than one dimension. To deal with this I assume the position and momentum vectors are stored in some <code>Apply</code> data structure. By doing this, I can write down the leap-frog integrator in generic terms. For the one-dimensional single pendulum, I have to wrap the <code>Number</code> into an <code>Apply</code> which I call <code>Scalar</code>.</p>
<div class="annotated-code">
<p><span><em>«leap-frog»=</em></span></p>
<div class="sourceCode" id="leap-frog"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="leap-frog-1" title="1">newtype <span class="dt">Scalar</span> a <span class="fu">=</span> <span class="dt">Scalar</span> a</a>
<a class="sourceLine" id="leap-frog-2" title="2"></a>
<a class="sourceLine" id="leap-frog-3" title="3">instance <span class="ot">scalarFunctor </span><span class="fu">::</span> <span class="dt">Functor</span> <span class="dt">Scalar</span> where</a>
<a class="sourceLine" id="leap-frog-4" title="4">    map f (<span class="dt">Scalar</span> a) <span class="fu">=</span> <span class="dt">Scalar</span> (f a)</a>
<a class="sourceLine" id="leap-frog-5" title="5"></a>
<a class="sourceLine" id="leap-frog-6" title="6">instance <span class="ot">scalarApply </span><span class="fu">::</span> <span class="dt">Apply</span> <span class="dt">Scalar</span> where</a>
<a class="sourceLine" id="leap-frog-7" title="7">    apply (<span class="dt">Scalar</span> f) (<span class="dt">Scalar</span> a) <span class="fu">=</span> <span class="dt">Scalar</span> (f a)</a>
<a class="sourceLine" id="leap-frog-8" title="8"></a>
<a class="sourceLine" id="leap-frog-9" title="9">instance <span class="ot">scalarApplicative </span><span class="fu">::</span> <span class="dt">Applicative</span> <span class="dt">Scalar</span> where</a>
<a class="sourceLine" id="leap-frog-10" title="10">    pure a <span class="fu">=</span> <span class="dt">Scalar</span> a</a></code></pre></div>
</div>
<div class="alert alert-info">
<p>A <code>Functor</code> is a type that can be mapped over. This mapping should hold to the <code>Functor</code> laws. It should preserve the identity function:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="cb1-1" title="1">map id <span class="fu">=</span> id</a></code></pre></div>
<p>and be linear over function composition</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="cb2-1" title="1">map (f <span class="fu">&lt;&lt;&lt;</span> g) <span class="fu">=</span> map f <span class="fu">&lt;&lt;&lt;</span> map g</a></code></pre></div>
<p>An <code>Applicative</code> is a type allows for combining <code>Functors</code> over functions with <code>Functors</code> over arguments. Combined with curried function application this lets us <code>map</code> over functions of multiple arguments. This is explained better than I ever could in the <a href="http://learnyouahaskell.com/functors-applicative-functors-and-monoids">“Learn you a Haskell” book chapter on Functors, Applicatives and Monoids</a>. Haskell and PureScript are similar enough for this reference to apply.</p>
</div>
<p>We can describe the <code>State</code> of a system by giving <code>time</code>, <code>position</code> and <code>momentum</code>. Here <code>a</code> is the type-parameter that indicates the container type. For instance, the <code>position</code> member of a <code>State Scalar</code> will have type <code>Scalar Number</code>.</p>
<div class="annotated-code">
<p><span><em>«leap-frog»+</em></span></p>
<div class="sourceCode" id="leap-frog"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="leap-frog-1" title="1"><span class="kw">type</span> <span class="dt">State</span> a <span class="fu">=</span></a>
<a class="sourceLine" id="leap-frog-2" title="2">    { <span class="ot">time </span><span class="fu">::</span> <span class="dt">Number</span></a>
<a class="sourceLine" id="leap-frog-3" title="3">    , <span class="ot">position </span><span class="fu">::</span> a <span class="dt">Number</span></a>
<a class="sourceLine" id="leap-frog-4" title="4">    , <span class="ot">momentum </span><span class="fu">::</span> a <span class="dt">Number</span> }</a></code></pre></div>
</div>
<p>Then, a Hamiltonian system is given by two sets of first-order differential equations.</p>
<div class="annotated-code">
<p><span><em>«leap-frog»+</em></span></p>
<div class="sourceCode" id="leap-frog"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="leap-frog-1" title="1"><span class="kw">type</span> <span class="dt">HamiltonianSystem</span> a <span class="fu">=</span></a>
<a class="sourceLine" id="leap-frog-2" title="2">    { <span class="ot">positionEquation </span><span class="fu">::</span> <span class="dt">State</span> a <span class="fu">-&gt;</span> a <span class="dt">Number</span></a>
<a class="sourceLine" id="leap-frog-3" title="3">    , <span class="ot">momentumEquation </span><span class="fu">::</span> <span class="dt">State</span> a <span class="fu">-&gt;</span> a <span class="dt">Number</span> }</a></code></pre></div>
</div>
<p>And in general, a <code>Solver</code> for the Hamiltonian system takes a state object and returns a new state.</p>
<div class="annotated-code">
<p><span><em>«leap-frog»+</em></span></p>
<div class="sourceCode" id="leap-frog"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="leap-frog-1" title="1"><span class="kw">type</span> <span class="dt">Solver</span> a <span class="fu">=</span> <span class="dt">HamiltonianSystem</span> a <span class="fu">-&gt;</span> <span class="dt">State</span> a <span class="fu">-&gt;</span> <span class="dt">State</span> a</a></code></pre></div>
</div>
<p>The leap-frog method is a solver that uses a <em>kick</em> and <em>drift</em> phase. The <em>kick</em> phase integrates only the momentum part of the system,</p>
<div class="annotated-code">
<p><span><em>«leap-frog»+</em></span></p>
<div class="sourceCode" id="leap-frog"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="leap-frog-1" title="1"><span class="ot">kick </span><span class="fu">::</span> forall f<span class="fu">.</span> (<span class="dt">Apply</span> f) </a>
<a class="sourceLine" id="leap-frog-2" title="2">    <span class="fu">=&gt;</span> <span class="dt">Number</span> <span class="fu">-&gt;</span> <span class="dt">HamiltonianSystem</span> f <span class="fu">-&gt;</span> <span class="dt">State</span> f <span class="fu">-&gt;</span> <span class="dt">State</span> f</a>
<a class="sourceLine" id="leap-frog-3" title="3">kick dt system state <span class="fu">=</span> state</a>
<a class="sourceLine" id="leap-frog-4" title="4">    { momentum <span class="fu">=</span> (\p dp <span class="fu">-&gt;</span> p <span class="fu">+</span> dt <span class="fu">*</span> dp)</a>
<a class="sourceLine" id="leap-frog-5" title="5">               <span class="fu">&lt;$&gt;</span> state<span class="fu">.</span>momentum</a>
<a class="sourceLine" id="leap-frog-6" title="6">               <span class="fu">&lt;*&gt;</span> system<span class="fu">.</span>momentumEquation state }</a></code></pre></div>
</div>
<p>while the <em>drift</em> phase only integrates the position part.</p>
<div class="annotated-code">
<p><span><em>«leap-frog»+</em></span></p>
<div class="sourceCode" id="leap-frog"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="leap-frog-1" title="1"><span class="ot">drift </span><span class="fu">::</span> forall f<span class="fu">.</span> (<span class="dt">Apply</span> f)</a>
<a class="sourceLine" id="leap-frog-2" title="2">    <span class="fu">=&gt;</span> <span class="dt">Number</span> <span class="fu">-&gt;</span> <span class="dt">HamiltonianSystem</span> f <span class="fu">-&gt;</span> <span class="dt">State</span> f <span class="fu">-&gt;</span> <span class="dt">State</span> f</a>
<a class="sourceLine" id="leap-frog-3" title="3">drift dt system state <span class="fu">=</span> state</a>
<a class="sourceLine" id="leap-frog-4" title="4">    { position <span class="fu">=</span> (\q dq <span class="fu">-&gt;</span> q <span class="fu">+</span> dt <span class="fu">*</span> dq)</a>
<a class="sourceLine" id="leap-frog-5" title="5">               <span class="fu">&lt;$&gt;</span> state<span class="fu">.</span>position</a>
<a class="sourceLine" id="leap-frog-6" title="6">               <span class="fu">&lt;*&gt;</span> system<span class="fu">.</span>positionEquation state }</a></code></pre></div>
</div>
<div class="alert alert-info">
<p>Note that, for instance in the <code>drift</code> function, the operators <code>&lt;$&gt;</code> and <code>&lt;*&gt;</code> are our way of applying the lambda-function <code>(\q dq -&gt; q + dt * dq)</code> to the <code>position</code> member of the state and the change in position given by the governing system of equations of motion. The <code>&lt;$&gt;</code> operator takes a function (of two arguments) and an applicative, call it a vector, and creates a vector of functions of one argument. Then the <code>&lt;*&gt;</code> operator applies the vector of functions to another vector of numbers. This way we can apply a function of <span class="math inline">\(n\)</span> arguments, point-wise to <span class="math inline">\(n\)</span> vectors, as long as these vectors are an instance of <code>Apply</code>.</p>
</div>
<p>We add a <em>wait</em> phase to control the clock, in case we encounter time-dependent systems, and because we move the clock by <code>dt/2</code> after each <em>kick</em> or <em>drift</em>, which is specific to the leap-frog method.</p>
<div class="annotated-code">
<p><span><em>«leap-frog»+</em></span></p>
<div class="sourceCode" id="leap-frog"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="leap-frog-1" title="1"><span class="ot">wait </span><span class="fu">::</span> forall a<span class="fu">.</span> <span class="dt">Number</span> <span class="fu">-&gt;</span> <span class="dt">State</span> a <span class="fu">-&gt;</span> <span class="dt">State</span> a</a>
<a class="sourceLine" id="leap-frog-2" title="2">wait dt state <span class="fu">=</span> state</a>
<a class="sourceLine" id="leap-frog-3" title="3">    { time <span class="fu">=</span> state<span class="fu">.</span>time <span class="fu">+</span> dt }</a></code></pre></div>
</div>
<p>The leap-frog method follows a kick by a drift, with a separation of <span class="math inline">\(dt/2\)</span>. We choose to start with a kick, then wait, drift, and wait again.</p>
<div class="annotated-code">
<p><span><em>«leap-frog»+</em></span></p>
<div class="sourceCode" id="leap-frog"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="leap-frog-1" title="1"><span class="ot">leapFrog </span><span class="fu">::</span> forall f<span class="fu">.</span> (<span class="dt">Apply</span> f)</a>
<a class="sourceLine" id="leap-frog-2" title="2">    <span class="fu">=&gt;</span> <span class="dt">Number</span> <span class="fu">-&gt;</span> <span class="dt">HamiltonianSystem</span> f <span class="fu">-&gt;</span> <span class="dt">State</span> f <span class="fu">-&gt;</span> <span class="dt">State</span> f</a>
<a class="sourceLine" id="leap-frog-3" title="3">leapFrog dt s <span class="fu">=</span> kick dt s <span class="fu">&gt;&gt;&gt;</span> wait (dt<span class="fu">/</span><span class="dv">2.0</span>) <span class="fu">&gt;&gt;&gt;</span> drift dt s <span class="fu">&gt;&gt;&gt;</span> wait (dt<span class="fu">/</span><span class="dv">2.0</span>)</a></code></pre></div>
</div>
<h3 id="halting-condition">Halting condition</h3>
<div class="annotated-code">
<p><span><em>«leap-frog»+</em></span></p>
<div class="sourceCode" id="leap-frog"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="leap-frog-1" title="1"><span class="kw">type</span> <span class="dt">HaltingCondition</span> a <span class="fu">=</span> <span class="dt">State</span> a <span class="fu">-&gt;</span> <span class="dt">State</span> a <span class="fu">-&gt;</span> <span class="dt">Boolean</span></a>
<a class="sourceLine" id="leap-frog-2" title="2"></a>
<a class="sourceLine" id="leap-frog-3" title="3"><span class="ot">haltAtTime </span><span class="fu">::</span> forall a<span class="fu">.</span> <span class="dt">Number</span> <span class="fu">-&gt;</span> <span class="dt">HaltingCondition</span> a</a>
<a class="sourceLine" id="leap-frog-4" title="4">haltAtTime t s1 s2 <span class="fu">=</span> s2<span class="fu">.</span>time <span class="fu">&gt;=</span> t </a></code></pre></div>
</div>
<h3 id="integration">Integration</h3>
<div class="annotated-code">
<p><span><em>«leap-frog»+</em></span></p>
<div class="sourceCode" id="leap-frog"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="leap-frog-1" title="1"><span class="ot">iterateSolution </span><span class="fu">::</span> forall a<span class="fu">.</span></a>
<a class="sourceLine" id="leap-frog-2" title="2">    (<span class="dt">State</span> a <span class="fu">-&gt;</span> <span class="dt">State</span> a) <span class="fu">-&gt;</span> <span class="dt">HaltingCondition</span> a <span class="fu">-&gt;</span> <span class="dt">State</span> a <span class="fu">-&gt;</span> <span class="dt">State</span> a</a>
<a class="sourceLine" id="leap-frog-3" title="3">iterateSolution method halt init <span class="fu">=</span></a>
<a class="sourceLine" id="leap-frog-4" title="4">    <span class="kw">let</span> next <span class="fu">=</span> method init</a>
<a class="sourceLine" id="leap-frog-5" title="5">    in <span class="kw">if</span> halt init next</a>
<a class="sourceLine" id="leap-frog-6" title="6">        <span class="kw">then</span> next</a>
<a class="sourceLine" id="leap-frog-7" title="7">        <span class="kw">else</span> iterateSolution method halt next</a>
<a class="sourceLine" id="leap-frog-8" title="8"></a>
<a class="sourceLine" id="leap-frog-9" title="9"><span class="ot">integrateSystem </span><span class="fu">::</span> forall a<span class="fu">.</span></a>
<a class="sourceLine" id="leap-frog-10" title="10">    <span class="dt">Solver</span> a <span class="fu">-&gt;</span> <span class="dt">HaltingCondition</span> a <span class="fu">-&gt;</span> <span class="dt">HamiltonianSystem</span> a <span class="fu">-&gt;</span> <span class="dt">State</span> a <span class="fu">-&gt;</span> <span class="dt">Array</span> (<span class="dt">State</span> a)</a>
<a class="sourceLine" id="leap-frog-11" title="11">integrateSystem solve halt f ic <span class="fu">=</span></a>
<a class="sourceLine" id="leap-frog-12" title="12">    <span class="kw">let</span> next <span class="fu">=</span> solve f ic</a>
<a class="sourceLine" id="leap-frog-13" title="13">    in <span class="kw">if</span> halt ic next</a>
<a class="sourceLine" id="leap-frog-14" title="14">        <span class="kw">then</span> ic <span class="fu">:</span> [next] <span class="fu">::</span> <span class="dt">Array</span> (<span class="dt">State</span> a)</a>
<a class="sourceLine" id="leap-frog-15" title="15">        <span class="kw">else</span> ic <span class="fu">:</span> integrateSystem solve halt f next</a></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«src/Hamilton.purs»=</em></span></p>
<div class="sourceCode" id="cb3" data-file="src/Hamilton.purs"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="cb3-1" title="1">module <span class="dt">Hamilton</span> where</a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3">import <span class="dt">Prelude</span></a>
<a class="sourceLine" id="cb3-4" title="4">import <span class="dt">Data.Array</span> ((<span class="fu">:</span>))</a>
<a class="sourceLine" id="cb3-5" title="5"></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="fu">&lt;&lt;</span>leap<span class="fu">-</span>frog<span class="fu">&gt;&gt;</span></a></code></pre></div>
</div>
<h2 id="integrating-the-single-pendulum">Integrating the single pendulum</h2>
<p>We had the following equations of motion,</p>
<p>Integrating this gives the time evolution of pendulum. We can compare it with the small-angle approximation. Here is a plot of the behaviour, you can change the initial angle with the slider.</p>
<figure>
<div id="pendulum-plot">

</div>
<div id="pendulum-control">

</div>
</figure>
<p>The source code for this interactive plot can be expanded below.</p>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#pendulum-main" aria-controls="pendulum-main">
&lt;&lt;pendulum-main&gt;&gt;=
</button>
<div id="pendulum-main" class="collapse">
<div class="card" style="height: 20em">
<div class="overflow-auto">
<div class="annotated-code">
<p><span><em>«src/Pendulum.purs»=</em></span></p>
<div class="sourceCode" id="cb4" data-file="src/Pendulum.purs"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="cb4-1" title="1">module <span class="dt">Pendulum</span> where</a>
<a class="sourceLine" id="cb4-2" title="2"></a>
<a class="sourceLine" id="cb4-3" title="3">import <span class="dt">Prelude</span></a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5">import <span class="dt">Effect</span> (<span class="dt">Effect</span>)</a>
<a class="sourceLine" id="cb4-6" title="6">import <span class="dt">Math</span> (pow, sin, sqrt, cos)</a>
<a class="sourceLine" id="cb4-7" title="7">import <span class="dt">Data.Array</span> ((<span class="fu">..</span>))</a>
<a class="sourceLine" id="cb4-8" title="8">import <span class="dt">Data.Int</span> (toNumber, round)</a>
<a class="sourceLine" id="cb4-9" title="9">import <span class="dt">Hamilton</span> (<span class="dt">HamiltonianSystem</span>, <span class="dt">Scalar</span> (<span class="fu">..</span>), <span class="dt">State</span>, leapFrog, integrateSystem, haltAtTime)</a>
<a class="sourceLine" id="cb4-10" title="10">import <span class="dt">Plotting</span> as <span class="dt">Plotting</span></a>
<a class="sourceLine" id="cb4-11" title="11"></a>
<a class="sourceLine" id="cb4-12" title="12">import <span class="dt">Flare</span> (runFlareWith, numberSlider)</a>
<a class="sourceLine" id="cb4-13" title="13"></a>
<a class="sourceLine" id="cb4-14" title="14"><span class="fu">&lt;&lt;</span>pendulum<span class="fu">-</span>model<span class="fu">&gt;&gt;</span></a>
<a class="sourceLine" id="cb4-15" title="15"></a>
<a class="sourceLine" id="cb4-16" title="16"><span class="kw">type</span> <span class="dt">Model</span> <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-17" title="17">        { <span class="ot">initAngle </span><span class="fu">::</span> <span class="dt">Number</span></a>
<a class="sourceLine" id="cb4-18" title="18">        , <span class="ot">dt </span><span class="fu">::</span> <span class="dt">Number</span></a>
<a class="sourceLine" id="cb4-19" title="19">        , <span class="ot">tEnd </span><span class="fu">::</span> <span class="dt">Number</span></a>
<a class="sourceLine" id="cb4-20" title="20">        , <span class="ot">length </span><span class="fu">::</span> <span class="dt">Number</span> }</a>
<a class="sourceLine" id="cb4-21" title="21"></a>
<a class="sourceLine" id="cb4-22" title="22"><span class="ot">updatePlot </span><span class="fu">::</span> <span class="dt">Number</span> <span class="fu">-&gt;</span> <span class="dt">Effect</span> <span class="dt">Unit</span></a>
<a class="sourceLine" id="cb4-23" title="23">updatePlot iq <span class="fu">=</span> do</a>
<a class="sourceLine" id="cb4-24" title="24">    <span class="kw">let</span> m <span class="fu">=</span> initModel { initAngle <span class="fu">=</span> iq }</a>
<a class="sourceLine" id="cb4-25" title="25">        result <span class="fu">=</span> integrateSystem (leapFrog m<span class="fu">.</span>dt) (haltAtTime m<span class="fu">.</span>tEnd)</a>
<a class="sourceLine" id="cb4-26" title="26">                                 (simplePendulum <span class="dv">9.81</span> m<span class="fu">.</span>length)</a>
<a class="sourceLine" id="cb4-27" title="27">                                 { time<span class="fu">:</span> <span class="dv">0.0</span>, position<span class="fu">:</span> <span class="dt">Scalar</span> m<span class="fu">.</span>initAngle, momentum<span class="fu">:</span> <span class="dt">Scalar</span> <span class="dv">0.0</span> }</a>
<a class="sourceLine" id="cb4-28" title="28">        small <span class="fu">=</span> smallAngle m</a>
<a class="sourceLine" id="cb4-29" title="29">    <span class="dt">Plotting</span><span class="fu">.</span>restyle <span class="st">&quot;pendulum-plot&quot;</span> <span class="st">&quot;y&quot;</span> [map (\{position<span class="fu">:</span> <span class="dt">Scalar</span> q} <span class="fu">-&gt;</span> q) result] [<span class="dv">0</span>]</a>
<a class="sourceLine" id="cb4-30" title="30">    <span class="dt">Plotting</span><span class="fu">.</span>restyle <span class="st">&quot;pendulum-plot&quot;</span> <span class="st">&quot;y&quot;</span> [small<span class="fu">.</span>y] [<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb4-31" title="31"></a>
<a class="sourceLine" id="cb4-32" title="32"><span class="ot">initModel </span><span class="fu">::</span> <span class="dt">Model</span></a>
<a class="sourceLine" id="cb4-33" title="33">initModel <span class="fu">=</span> { initAngle<span class="fu">:</span> <span class="dv">3.0</span>, dt<span class="fu">:</span> <span class="dv">0.1</span>, tEnd<span class="fu">:</span> <span class="dv">10.0</span>, length<span class="fu">:</span> <span class="dv">1.0</span> }</a>
<a class="sourceLine" id="cb4-34" title="34"></a>
<a class="sourceLine" id="cb4-35" title="35"><span class="ot">convertResult </span><span class="fu">::</span> <span class="dt">Array</span> (<span class="dt">State</span> <span class="dt">Scalar</span>) <span class="fu">-&gt;</span> <span class="dt">Plotting.PlotData</span></a>
<a class="sourceLine" id="cb4-36" title="36">convertResult rs <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-37" title="37">    { x<span class="fu">:</span> map (\{time} <span class="fu">-&gt;</span> time <span class="fu">+</span> initModel<span class="fu">.</span>dt<span class="fu">/</span><span class="dv">2.0</span>) rs</a>
<a class="sourceLine" id="cb4-38" title="38">    , y<span class="fu">:</span> map (\{position<span class="fu">:</span> <span class="dt">Scalar</span> q} <span class="fu">-&gt;</span> q) rs</a>
<a class="sourceLine" id="cb4-39" title="39">    , mode<span class="fu">:</span> <span class="st">&quot;lines+markers&quot;</span> }</a>
<a class="sourceLine" id="cb4-40" title="40"></a>
<a class="sourceLine" id="cb4-41" title="41"><span class="ot">smallAngle </span><span class="fu">::</span> <span class="dt">Model</span> <span class="fu">-&gt;</span> <span class="dt">Plotting.PlotData</span></a>
<a class="sourceLine" id="cb4-42" title="42">smallAngle m <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-43" title="43">    <span class="kw">let</span> period <span class="fu">=</span> sqrt <span class="fu">$</span> m<span class="fu">.</span>length <span class="fu">/</span> <span class="dv">9.81</span></a>
<a class="sourceLine" id="cb4-44" title="44">        ts <span class="fu">=</span> (\i <span class="fu">-&gt;</span> m<span class="fu">.</span>dt <span class="fu">*</span> (toNumber i)) <span class="fu">&lt;$&gt;</span> <span class="dv">0</span><span class="fu">..</span>(round <span class="fu">$</span> m<span class="fu">.</span>tEnd <span class="fu">/</span> m<span class="fu">.</span>dt)</a>
<a class="sourceLine" id="cb4-45" title="45">        ys <span class="fu">=</span> (\t <span class="fu">-&gt;</span> m<span class="fu">.</span>initAngle <span class="fu">*</span> (cos <span class="fu">$</span> t <span class="fu">/</span> period)) <span class="fu">&lt;$&gt;</span> ts</a>
<a class="sourceLine" id="cb4-46" title="46">    in { x<span class="fu">:</span> ts, y<span class="fu">:</span> ys, mode<span class="fu">:</span> <span class="st">&quot;lines&quot;</span> }</a>
<a class="sourceLine" id="cb4-47" title="47"></a>
<a class="sourceLine" id="cb4-48" title="48"><span class="ot">main </span><span class="fu">::</span> <span class="dt">Effect</span> <span class="dt">Unit</span></a>
<a class="sourceLine" id="cb4-49" title="49">main <span class="fu">=</span> do</a>
<a class="sourceLine" id="cb4-50" title="50">    <span class="kw">let</span> result <span class="fu">=</span> integrateSystem (leapFrog initModel<span class="fu">.</span>dt) (haltAtTime <span class="dv">10.0</span>)</a>
<a class="sourceLine" id="cb4-51" title="51">                                 (simplePendulum <span class="dv">9.81</span> <span class="dv">1.0</span>)</a>
<a class="sourceLine" id="cb4-52" title="52">                                 { time<span class="fu">:</span> <span class="dv">0.0</span>, position<span class="fu">:</span> <span class="dt">Scalar</span> <span class="dv">3.0</span>, momentum<span class="fu">:</span> <span class="dt">Scalar</span> <span class="dv">0.0</span> }</a>
<a class="sourceLine" id="cb4-53" title="53">        slider <span class="fu">=</span> numberSlider <span class="st">&quot;initial angle&quot;</span> <span class="dv">0.01</span> <span class="dv">3.14</span> <span class="dv">0.01</span> <span class="dv">1.57</span></a>
<a class="sourceLine" id="cb4-54" title="54"></a>
<a class="sourceLine" id="cb4-55" title="55">    <span class="dt">Plotting</span><span class="fu">.</span>lineChart <span class="st">&quot;pendulum-plot&quot;</span> [convertResult result, smallAngle initModel] { title<span class="fu">:</span> <span class="st">&quot;pendulum&quot;</span> }</a>
<a class="sourceLine" id="cb4-56" title="56">    runFlareWith <span class="st">&quot;pendulum-control&quot;</span> updatePlot slider</a></code></pre></div>
</div>
</div>
</div>
</div>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script type="text/javascript" src="js/pendulum.js"></script>
<p><br><br></p>
<h1 id="the-double-pendulum">The double pendulum</h1>
<p>The double pendulum is more complicated than the single one. We now have two angles <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\varphi\)</span>, two lengths <span class="math inline">\(k\)</span> and <span class="math inline">\(l\)</span>, and two masses <span class="math inline">\(m\)</span> and <span class="math inline">\(n\)</span>. The potential energy is</p>
<p><span class="math display">\[U(\theta, \varphi) = - m g k \cos{\theta} - n g (k \cos{\theta} + l \cos{\varphi}),\]</span></p>
<p>and the kinetic energy (takes a bit of calculating),</p>
<p><span class="math display">\[T(\theta, \varphi, \dot{\theta}, \dot{\varphi}) = \frac{1}{2} m k^2 \dot{\theta}^2 + \frac{1}{2} n \left(\dot{\theta}^2 k^2 + \dot{\varphi}^2 l^2 + 2\dot{\theta}\dot{\varphi}kl \cos(\theta - \varphi)\right).\]</span></p>
<div class="annotated-code">
<p><span><em>«double-pendulum»=</em></span></p>
<div class="sourceCode" id="double-pendulum"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="double-pendulum-1" title="1"><span class="kw">type</span> <span class="dt">DoublePendulum</span> <span class="fu">=</span></a>
<a class="sourceLine" id="double-pendulum-2" title="2">        { <span class="ot">l1 </span><span class="fu">::</span> <span class="dt">Number</span></a>
<a class="sourceLine" id="double-pendulum-3" title="3">        , <span class="ot">m1 </span><span class="fu">::</span> <span class="dt">Number</span></a>
<a class="sourceLine" id="double-pendulum-4" title="4">        , <span class="ot">l2 </span><span class="fu">::</span> <span class="dt">Number</span></a>
<a class="sourceLine" id="double-pendulum-5" title="5">        , <span class="ot">m2 </span><span class="fu">::</span> <span class="dt">Number</span></a>
<a class="sourceLine" id="double-pendulum-6" title="6">        , <span class="ot">g  </span><span class="fu">::</span> <span class="dt">Number</span> }</a></code></pre></div>
</div>
<p>We describe the pendulum in terms of the coordinates <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\varphi\)</span>. Just as we did for the <code>Scalar</code> type, we need to define how to map over the <code>Coordinates</code> type, meaning we have to create an <code>Applicative</code> instance.</p>
<div class="annotated-code">
<p><span><em>«double-pendulum»+</em></span></p>
<div class="sourceCode" id="double-pendulum"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="double-pendulum-1" title="1">newtype <span class="dt">Coordinates</span> a <span class="fu">=</span> <span class="dt">Coordinates</span></a>
<a class="sourceLine" id="double-pendulum-2" title="2">        { <span class="ot">theta </span><span class="fu">::</span> a</a>
<a class="sourceLine" id="double-pendulum-3" title="3">        , <span class="ot">phi   </span><span class="fu">::</span> a }</a>
<a class="sourceLine" id="double-pendulum-4" title="4"></a>
<a class="sourceLine" id="double-pendulum-5" title="5">instance <span class="ot">functorCoordinates </span><span class="fu">::</span> <span class="dt">Functor</span> <span class="dt">Coordinates</span> where</a>
<a class="sourceLine" id="double-pendulum-6" title="6">    map f (<span class="dt">Coordinates</span> { theta, phi }) <span class="fu">=</span></a>
<a class="sourceLine" id="double-pendulum-7" title="7">        <span class="dt">Coordinates</span> { theta<span class="fu">:</span> f theta, phi<span class="fu">:</span> f phi }</a>
<a class="sourceLine" id="double-pendulum-8" title="8"></a>
<a class="sourceLine" id="double-pendulum-9" title="9">instance <span class="ot">applyCoordinates </span><span class="fu">::</span> <span class="dt">Apply</span> <span class="dt">Coordinates</span> where</a>
<a class="sourceLine" id="double-pendulum-10" title="10">    apply (<span class="dt">Coordinates</span> { theta<span class="fu">:</span> fTheta, phi<span class="fu">:</span> fPhi })</a>
<a class="sourceLine" id="double-pendulum-11" title="11">          (<span class="dt">Coordinates</span> { theta, phi }) <span class="fu">=</span></a>
<a class="sourceLine" id="double-pendulum-12" title="12">        <span class="dt">Coordinates</span> { theta<span class="fu">:</span> fTheta theta, phi<span class="fu">:</span> fPhi phi }</a>
<a class="sourceLine" id="double-pendulum-13" title="13"></a>
<a class="sourceLine" id="double-pendulum-14" title="14">instance <span class="ot">applicativeCoordinates </span><span class="fu">::</span> <span class="dt">Applicative</span> <span class="dt">Coordinates</span> where</a>
<a class="sourceLine" id="double-pendulum-15" title="15">    pure a <span class="fu">=</span> <span class="dt">Coordinates</span> { theta<span class="fu">:</span> a, phi<span class="fu">:</span> a }</a>
<a class="sourceLine" id="double-pendulum-16" title="16"></a>
<a class="sourceLine" id="double-pendulum-17" title="17">instance <span class="ot">showCoordinates </span><span class="fu">::</span> <span class="dt">Show</span> a <span class="fu">=&gt;</span> <span class="dt">Show</span> (<span class="dt">Coordinates</span> a) where</a>
<a class="sourceLine" id="double-pendulum-18" title="18">    show (<span class="dt">Coordinates</span> x) <span class="fu">=</span> show x</a></code></pre></div>
</div>
<p>We choose the position vector <span class="math inline">\(\vec{q} = (\theta, \varphi)\)</span>, then the canonical momentum is <span class="math inline">\(\vec{p} = \partial_{\dot{\vec{q}}} \mathcal{L}\)</span>. This gives the terrible momentum vector,</p>
<p><span class="math display">\[\vec{p} = \begin{pmatrix}
mk^2\dot{\theta} + nk^2\dot{\theta} + nkl \dot{\varphi} \cos(\theta - \varphi)\\
nl^2\dot{\varphi} + nkl \dot{\theta} \cos(\theta - \varphi)
\end{pmatrix}.\]</span></p>
<p>We need to write the Hamiltonian <span class="math inline">\(\mathcal{H}\)</span> in terms of <span class="math inline">\(\vec{q}\)</span> and <span class="math inline">\(\vec{p}\)</span>. This is possible. I stole and rewrote this derivation from <a href="https://diego.assencio.com/?index=e5ac36fcb129ce95a61f8e8ce0572dbf">Diego Assencio’s blog</a>.</p>
<p>We can rewrite our expression for <span class="math inline">\(\vec{p}\)</span> in a matrix-vector form,</p>
<p><span class="math display">\[\vec{p} = B \dot{\vec{q}},\]</span></p>
<p>where</p>
<p><span class="math display">\[B = \begin{pmatrix}
(m + n)k^2 &amp;&amp; nkl \cos(\theta - \varphi)\\ nkl \cos(\theta - \varphi) &amp;&amp; nl^2
\end{pmatrix}.\]</span></p>
<p>Then we can write the velocities <span class="math inline">\(\dot{\vec{q}} = B^{-1} \vec{p}\)</span>. The inverse of a <span class="math inline">\(2\times2\)</span> symmetric matrix is given by</p>
<p><span class="math display">\[B^{-1} = \begin{pmatrix}
a &amp;&amp; c \\ c &amp;&amp; b\end{pmatrix}^{-1} = \frac{1}{ab - c^2} \begin{pmatrix} b &amp;&amp; -c \\ -c &amp;&amp; a
\end{pmatrix}.\]</span></p>
<p>We will write <span class="math display">\[D = \det B = nk^2l^2 \left(m + n \sin^2(\theta - \varphi)\right).\]</span> From this expression for the determinant it is clear that <span class="math inline">\(D \ge nmk^2l^2\)</span>, and that the inverse <span class="math inline">\(B^{-1}\)</span> exists.</p>
<p>Now it is helpful to write <span class="math inline">\(T(\theta, \varphi, \dot{\theta}, \dot{\varphi})\)</span> in terms of <span class="math inline">\(a, b, c\)</span> and <span class="math inline">\(d\)</span>,</p>
<p><span class="math display">\[T = \frac{1}{2}\left(a\dot{\theta}^2 + b\dot{\varphi} + 2c\dot{\theta}\dot{\varphi}\right).\]</span></p>
<p>Inserting <span class="math inline">\(\dot{\theta} = (p_{\theta}b - p_{\varphi}c)/D\)</span> and <span class="math inline">\(\dot{\varphi} = (p_{\varphi}a - p_{\varphi}c)/D\)</span>, things magically work out (making me feel I did too much work) and we get,</p>
<p><span class="math display">\[T = \frac{bp_{\theta}^2 + ap_{\varphi}^2 - 2cp_{\theta}p_{\varphi}}{2D},\]</span></p>
<div class="annotated-code">
<p><span><em>«double-pendulum»+</em></span></p>
<div class="sourceCode" id="double-pendulum"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="double-pendulum-1" title="1"><span class="ot">kineticEnergy </span><span class="fu">::</span> <span class="dt">DoublePendulum</span> <span class="fu">-&gt;</span> <span class="dt">Coordinates</span> <span class="dt">Number</span> <span class="fu">-&gt;</span> <span class="dt">Coordinates</span> <span class="dt">Number</span> <span class="fu">-&gt;</span> <span class="dt">Number</span></a>
<a class="sourceLine" id="double-pendulum-2" title="2">kineticEnergy z (<span class="dt">Coordinates</span> q) (<span class="dt">Coordinates</span> p) <span class="fu">=</span></a>
<a class="sourceLine" id="double-pendulum-3" title="3">    (b <span class="fu">*</span> (pow p<span class="fu">.</span>theta <span class="dv">2.0</span>) <span class="fu">+</span> a <span class="fu">*</span> (pow p<span class="fu">.</span>phi <span class="dv">2.0</span>) <span class="fu">-</span> <span class="dv">2.0</span> <span class="fu">*</span> c <span class="fu">*</span> p<span class="fu">.</span>theta <span class="fu">*</span> p<span class="fu">.</span>phi) <span class="fu">/</span> (<span class="dv">2.0</span> <span class="fu">*</span> det)</a>
<a class="sourceLine" id="double-pendulum-4" title="4">    where a <span class="fu">=</span> (z<span class="fu">.</span>m1 <span class="fu">+</span> z<span class="fu">.</span>m2) <span class="fu">*</span> (pow z<span class="fu">.</span>l1 <span class="dv">2.0</span>)</a>
<a class="sourceLine" id="double-pendulum-5" title="5">          b <span class="fu">=</span> z<span class="fu">.</span>m2 <span class="fu">*</span> (pow z<span class="fu">.</span>l2 <span class="dv">2.0</span>)</a>
<a class="sourceLine" id="double-pendulum-6" title="6">          c <span class="fu">=</span> z<span class="fu">.</span>m2 <span class="fu">*</span> z<span class="fu">.</span>l1 <span class="fu">*</span> z<span class="fu">.</span>l2 <span class="fu">*</span> (cos <span class="fu">$</span> q<span class="fu">.</span>theta <span class="fu">-</span> q<span class="fu">.</span>phi)</a>
<a class="sourceLine" id="double-pendulum-7" title="7">          det <span class="fu">=</span> a <span class="fu">*</span> b <span class="fu">-</span> c <span class="fu">*</span> c</a></code></pre></div>
</div>
<p>and the Hamiltonian becomes</p>
<p><span class="math display">\[\mathcal{H} = \frac
{nl^2 p_{\theta}^2 + (m + n)k^2 p_{\varphi}^2 - 2nkl p_{\theta} p_{\varphi} \cos(\theta - \varphi)}
{2nk^2l^2 \left(m + n \sin^2(\theta - \varphi)\right)}
- (m + n)gk \cos{\theta} - ngl \cos{\varphi}.\]</span></p>
<p>Now we get the Hamilton equations of motion, <span class="math inline">\(\dot{\vec{p}} = - \partial_q \mathcal{H}\)</span> and <span class="math inline">\(\dot{\vec{q}} = + \partial_p \mathcal{H}\)</span>,</p>
<p><span class="math display">\[\begin{align}
\dot{\theta} = \partial_{p_{\theta}} \mathcal{H} =&amp; \frac{nl}{D} \left(l p_{\theta} - k\cos(\theta - \varphi) p_{\varphi}\right),\\
\dot{\varphi} = \partial_{p_{\varphi}} \mathcal{H} =&amp; \frac{k}{D} \left((m+n)k p_{\varphi} - nl\cos(\theta - \varphi) p_{\theta}\right),\\
\dot{p}_{\theta} = -\partial_{\theta} \mathcal{H} =&amp;\xi - (m+n)gk \sin \theta,\\
\dot{p}_{\varphi} = -\partial_{\varphi} \mathcal{H} =&amp; -\xi - ngl \sin \varphi,
\end{align}\]</span></p>
<p>where</p>
<p><span class="math display">\[\xi = \frac{nkl}{2D}\left(T\ nkl\sin(2(\theta - \varphi)) - 2\sin(\theta - \varphi) p_{\theta} p_{\varphi}\right).\]</span></p>
<div class="annotated-code">
<p><span><em>«double-pendulum»+</em></span></p>
<div class="sourceCode" id="double-pendulum"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="double-pendulum-1" title="1"><span class="ot">doublePendulum </span><span class="fu">::</span> <span class="dt">DoublePendulum</span> <span class="fu">-&gt;</span> <span class="dt">HamiltonianSystem</span> <span class="dt">Coordinates</span></a>
<a class="sourceLine" id="double-pendulum-2" title="2">doublePendulum z <span class="fu">=</span> { positionEquation, momentumEquation }</a>
<a class="sourceLine" id="double-pendulum-3" title="3">    where positionEquation { position<span class="fu">:</span> <span class="dt">Coordinates</span> q, momentum<span class="fu">:</span> <span class="dt">Coordinates</span> p } <span class="fu">=</span> </a>
<a class="sourceLine" id="double-pendulum-4" title="4">              <span class="dt">Coordinates</span> { theta<span class="fu">:</span> dtQTheta, phi<span class="fu">:</span> dtQPhi }</a>
<a class="sourceLine" id="double-pendulum-5" title="5">              where dtQTheta <span class="fu">=</span> z<span class="fu">.</span>m2 <span class="fu">*</span> z<span class="fu">.</span>l2 <span class="fu">/</span> (det q) <span class="fu">*</span> (z<span class="fu">.</span>l2 <span class="fu">*</span> p<span class="fu">.</span>theta</a>
<a class="sourceLine" id="double-pendulum-6" title="6">                             <span class="fu">-</span> z<span class="fu">.</span>l1 <span class="fu">*</span> (mu q) <span class="fu">*</span> p<span class="fu">.</span>phi)</a>
<a class="sourceLine" id="double-pendulum-7" title="7">                    dtQPhi   <span class="fu">=</span> z<span class="fu">.</span>l1 <span class="fu">/</span> (det q) <span class="fu">*</span> ((z<span class="fu">.</span>m1 <span class="fu">+</span> z<span class="fu">.</span>m2) <span class="fu">*</span> z<span class="fu">.</span>l1 <span class="fu">*</span> p<span class="fu">.</span>phi</a>
<a class="sourceLine" id="double-pendulum-8" title="8">                             <span class="fu">-</span> z<span class="fu">.</span>m2 <span class="fu">*</span> z<span class="fu">.</span>l2 <span class="fu">*</span> (mu q) <span class="fu">*</span> p<span class="fu">.</span>theta)</a>
<a class="sourceLine" id="double-pendulum-9" title="9"></a>
<a class="sourceLine" id="double-pendulum-10" title="10">          momentumEquation { position<span class="fu">:</span> <span class="dt">Coordinates</span> q, momentum<span class="fu">:</span> <span class="dt">Coordinates</span> p } <span class="fu">=</span> </a>
<a class="sourceLine" id="double-pendulum-11" title="11">             <span class="dt">Coordinates</span> { theta<span class="fu">:</span> dtPTheta, phi<span class="fu">:</span> dtPPhi }</a>
<a class="sourceLine" id="double-pendulum-12" title="12">             where dtPTheta <span class="fu">=</span> xi <span class="fu">-</span> (z<span class="fu">.</span>m1 <span class="fu">+</span> z<span class="fu">.</span>m2) <span class="fu">*</span> z<span class="fu">.</span>g <span class="fu">*</span> z<span class="fu">.</span>m1 <span class="fu">*</span> (sin q<span class="fu">.</span>theta)</a>
<a class="sourceLine" id="double-pendulum-13" title="13">                   dtPPhi   <span class="fu">=</span> <span class="fu">-</span> xi <span class="fu">-</span> z<span class="fu">.</span>m2 <span class="fu">*</span> z<span class="fu">.</span>g <span class="fu">*</span> z<span class="fu">.</span>l2 <span class="fu">*</span> (sin q<span class="fu">.</span>phi)</a>
<a class="sourceLine" id="double-pendulum-14" title="14">                   xi       <span class="fu">=</span> z<span class="fu">.</span>m2 <span class="fu">*</span> z<span class="fu">.</span>l1 <span class="fu">*</span> z<span class="fu">.</span>l2 <span class="fu">/</span> (<span class="dv">2.0</span> <span class="fu">*</span> (det q))</a>
<a class="sourceLine" id="double-pendulum-15" title="15">                            <span class="fu">*</span> ((kineticEnergy z (<span class="dt">Coordinates</span> q) (<span class="dt">Coordinates</span> p)) <span class="fu">*</span> z<span class="fu">.</span>m2 <span class="fu">*</span> z<span class="fu">.</span>l1 <span class="fu">*</span> z<span class="fu">.</span>l2 </a>
<a class="sourceLine" id="double-pendulum-16" title="16">                               <span class="fu">*</span> (sin <span class="fu">$</span> <span class="dv">2.0</span> <span class="fu">*</span> (q<span class="fu">.</span>theta <span class="fu">-</span> q<span class="fu">.</span>phi))</a>
<a class="sourceLine" id="double-pendulum-17" title="17">                               <span class="fu">-</span> <span class="dv">2.0</span> <span class="fu">*</span> (sin <span class="fu">$</span> q<span class="fu">.</span>theta <span class="fu">-</span> q<span class="fu">.</span>phi) <span class="fu">*</span> p<span class="fu">.</span>theta <span class="fu">*</span> p<span class="fu">.</span>phi)</a>
<a class="sourceLine" id="double-pendulum-18" title="18"></a>
<a class="sourceLine" id="double-pendulum-19" title="19">          mu q  <span class="fu">=</span> cos <span class="fu">$</span> q<span class="fu">.</span>theta <span class="fu">-</span> q<span class="fu">.</span>phi</a>
<a class="sourceLine" id="double-pendulum-20" title="20"></a>
<a class="sourceLine" id="double-pendulum-21" title="21">          det q <span class="fu">=</span> a <span class="fu">*</span> b <span class="fu">-</span> c <span class="fu">*</span> c</a>
<a class="sourceLine" id="double-pendulum-22" title="22">              where a <span class="fu">=</span> (z<span class="fu">.</span>m1 <span class="fu">+</span> z<span class="fu">.</span>m2) <span class="fu">*</span> (pow z<span class="fu">.</span>l1 <span class="dv">2.0</span>)</a>
<a class="sourceLine" id="double-pendulum-23" title="23">                    b <span class="fu">=</span> z<span class="fu">.</span>m2 <span class="fu">*</span> (pow z<span class="fu">.</span>l2 <span class="dv">2.0</span>)</a>
<a class="sourceLine" id="double-pendulum-24" title="24">                    c <span class="fu">=</span> z<span class="fu">.</span>m2 <span class="fu">*</span> z<span class="fu">.</span>l1 <span class="fu">*</span> z<span class="fu">.</span>l2 <span class="fu">*</span> (mu q)</a></code></pre></div>
</div>
<p>Terrible indeed. It is amazing how quickly the addition of another pendulum to the system just explodes in your face. Since we have a <code>HamiltonianSystem</code> defined for the double pendulum, integration of this system is the same as integrating the single pendulum. The next section describes how I made the animation at the top of this page.</p>
<h1 id="animation-using-flare">Animation using Flare</h1>
<p>We have an animation canvas and a button that controls if the animation plays or not. The <code>Model</code> is as follows:</p>
<div class="annotated-code">
<p><span><em>«double-pendulum-animation»=</em></span></p>
<div class="sourceCode" id="double-pendulum-animation"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="double-pendulum-animation-1" title="1"><span class="kw">type</span> <span class="dt">Model</span> <span class="fu">=</span></a>
<a class="sourceLine" id="double-pendulum-animation-2" title="2">    { <span class="ot">state       </span><span class="fu">::</span> <span class="dt">State</span> <span class="dt">Coordinates</span></a>
<a class="sourceLine" id="double-pendulum-animation-3" title="3">    , <span class="ot">params      </span><span class="fu">::</span> <span class="dt">DoublePendulum</span></a>
<a class="sourceLine" id="double-pendulum-animation-4" title="4">    , <span class="ot">currentTime </span><span class="fu">::</span> <span class="dt">Number</span></a>
<a class="sourceLine" id="double-pendulum-animation-5" title="5">    , <span class="ot">timeStep    </span><span class="fu">::</span> <span class="dt">Number</span></a>
<a class="sourceLine" id="double-pendulum-animation-6" title="6">    , <span class="ot">playing     </span><span class="fu">::</span> <span class="dt">Boolean</span> }</a></code></pre></div>
</div>
<p>The model is updated by passing messages to an <code>update</code> function.</p>
<div class="annotated-code">
<p><span><em>«double-pendulum-animation»+</em></span></p>
<div class="sourceCode" id="double-pendulum-animation"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="double-pendulum-animation-1" title="1">data <span class="dt">Msg</span> <span class="fu">=</span></a>
<a class="sourceLine" id="double-pendulum-animation-2" title="2">      <span class="dt">AnimationFrame</span> <span class="dt">Number</span></a>
<a class="sourceLine" id="double-pendulum-animation-3" title="3">    <span class="fu">|</span> <span class="dt">TogglePlay</span></a>
<a class="sourceLine" id="double-pendulum-animation-4" title="4">    <span class="fu">|</span> <span class="dt">None</span></a></code></pre></div>
</div>
<p>Updating the model:</p>
<div class="annotated-code">
<p><span><em>«double-pendulum-animation»+</em></span></p>
<div class="sourceCode" id="double-pendulum-animation"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="double-pendulum-animation-1" title="1"><span class="ot">forwardModel </span><span class="fu">::</span> <span class="dt">Number</span> <span class="fu">-&gt;</span> <span class="dt">Model</span> <span class="fu">-&gt;</span> <span class="dt">Model</span></a>
<a class="sourceLine" id="double-pendulum-animation-2" title="2">forwardModel dt m <span class="fu">=</span> m { state <span class="fu">=</span> moduloState newState</a>
<a class="sourceLine" id="double-pendulum-animation-3" title="3">                      , currentTime <span class="fu">=</span> newTime }</a>
<a class="sourceLine" id="double-pendulum-animation-4" title="4">    where newState <span class="fu">=</span> iterateSolution</a>
<a class="sourceLine" id="double-pendulum-animation-5" title="5">            (leapFrog m<span class="fu">.</span>timeStep (doublePendulum m<span class="fu">.</span>params))</a>
<a class="sourceLine" id="double-pendulum-animation-6" title="6">            (haltAtTime <span class="fu">$</span> m<span class="fu">.</span>state<span class="fu">.</span>time <span class="fu">+</span> dt)</a>
<a class="sourceLine" id="double-pendulum-animation-7" title="7">            m<span class="fu">.</span>state</a>
<a class="sourceLine" id="double-pendulum-animation-8" title="8">          newTime <span class="fu">=</span> m<span class="fu">.</span>currentTime <span class="fu">+</span> newState<span class="fu">.</span>time <span class="fu">-</span> m<span class="fu">.</span>state<span class="fu">.</span>time</a>
<a class="sourceLine" id="double-pendulum-animation-9" title="9"></a>
<a class="sourceLine" id="double-pendulum-animation-10" title="10"><span class="ot">moduloState </span><span class="fu">::</span> <span class="dt">State</span> <span class="dt">Coordinates</span> <span class="fu">-&gt;</span> <span class="dt">State</span> <span class="dt">Coordinates</span></a>
<a class="sourceLine" id="double-pendulum-animation-11" title="11">moduloState s<span class="fu">@</span>{ position<span class="fu">:</span> <span class="dt">Coordinates</span> { theta, phi } } <span class="fu">=</span></a>
<a class="sourceLine" id="double-pendulum-animation-12" title="12">    s { position <span class="fu">=</span> <span class="dt">Coordinates</span> { theta<span class="fu">:</span> theta <span class="fu">%</span> (<span class="dv">2.0</span><span class="fu">*</span>pi)</a>
<a class="sourceLine" id="double-pendulum-animation-13" title="13">                               , phi<span class="fu">:</span> phi <span class="fu">%</span> (<span class="dv">2.0</span><span class="fu">*</span>pi) } }</a>
<a class="sourceLine" id="double-pendulum-animation-14" title="14"></a>
<a class="sourceLine" id="double-pendulum-animation-15" title="15"><span class="ot">update </span><span class="fu">::</span> <span class="dt">Msg</span> <span class="fu">-&gt;</span> <span class="dt">Model</span> <span class="fu">-&gt;</span> <span class="dt">Model</span></a>
<a class="sourceLine" id="double-pendulum-animation-16" title="16">update (<span class="dt">AnimationFrame</span> t) m <span class="fu">=</span> <span class="kw">if</span> (t <span class="fu">/</span> <span class="dv">1000.0</span> <span class="fu">-</span> m<span class="fu">.</span>currentTime) <span class="fu">&gt;</span> m<span class="fu">.</span>timeStep</a>
<a class="sourceLine" id="double-pendulum-animation-17" title="17">    <span class="kw">then</span> <span class="kw">if</span> m<span class="fu">.</span>playing</a>
<a class="sourceLine" id="double-pendulum-animation-18" title="18">         <span class="kw">then</span> forwardModel (t <span class="fu">/</span> <span class="dv">1000.0</span> <span class="fu">-</span> m<span class="fu">.</span>currentTime) m</a>
<a class="sourceLine" id="double-pendulum-animation-19" title="19">         <span class="kw">else</span> m { currentTime <span class="fu">=</span> t <span class="fu">/</span> <span class="dv">1000.0</span> }</a>
<a class="sourceLine" id="double-pendulum-animation-20" title="20">    <span class="kw">else</span> m</a>
<a class="sourceLine" id="double-pendulum-animation-21" title="21">update <span class="dt">TogglePlay</span> m <span class="fu">=</span> m { playing <span class="fu">=</span> not m<span class="fu">.</span>playing }</a>
<a class="sourceLine" id="double-pendulum-animation-22" title="22">update <span class="dt">None</span> m <span class="fu">=</span> m</a></code></pre></div>
</div>
<p>And we use the following initial state:</p>
<div class="annotated-code">
<p><span><em>«double-pendulum-animation»+</em></span></p>
<div class="sourceCode" id="double-pendulum-animation"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="double-pendulum-animation-1" title="1"><span class="ot">initModel </span><span class="fu">::</span> <span class="dt">Model</span></a>
<a class="sourceLine" id="double-pendulum-animation-2" title="2">initModel <span class="fu">=</span></a>
<a class="sourceLine" id="double-pendulum-animation-3" title="3">    { state<span class="fu">:</span>  { position<span class="fu">:</span> <span class="dt">Coordinates</span> { theta<span class="fu">:</span> pi <span class="fu">/</span> <span class="dv">2.0</span>, phi<span class="fu">:</span> <span class="dv">0.0</span> }</a>
<a class="sourceLine" id="double-pendulum-animation-4" title="4">              , momentum<span class="fu">:</span> <span class="dt">Coordinates</span> { theta<span class="fu">:</span> <span class="dv">0.0</span>,      phi<span class="fu">:</span> <span class="dv">0.0</span> }</a>
<a class="sourceLine" id="double-pendulum-animation-5" title="5">              , time<span class="fu">:</span> <span class="dv">0.0</span> }</a>
<a class="sourceLine" id="double-pendulum-animation-6" title="6">    , params<span class="fu">:</span> { l1<span class="fu">:</span> <span class="dv">1.6</span>, l2<span class="fu">:</span> <span class="dv">1.2</span>, m1<span class="fu">:</span> <span class="dv">2.0</span>, m2<span class="fu">:</span> <span class="dv">1.5</span>, g<span class="fu">:</span> <span class="dv">9.81</span> }</a>
<a class="sourceLine" id="double-pendulum-animation-7" title="7">    , currentTime<span class="fu">:</span> <span class="dv">0.0</span></a>
<a class="sourceLine" id="double-pendulum-animation-8" title="8">    , timeStep<span class="fu">:</span> <span class="dv">0.01</span></a>
<a class="sourceLine" id="double-pendulum-animation-9" title="9">    , playing<span class="fu">:</span> false }</a></code></pre></div>
</div>
<h2 id="flare">Flare</h2>
<p>Using <code>Flare</code> we can create a set of UI controls that generate a stream of messages. The <code>events</code> function takes a <code>Signal Number</code> argument that generates a signal for every animation frame.</p>
<div class="annotated-code">
<p><span><em>«double-pendulum-flare»=</em></span></p>
<div class="sourceCode" id="double-pendulum-flare"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="double-pendulum-flare-1" title="1"><span class="ot">events </span><span class="fu">::</span> <span class="dt">Signal.Signal</span> <span class="dt">Number</span> <span class="fu">-&gt;</span> <span class="dt">Flare.UI</span> <span class="dt">Msg</span></a>
<a class="sourceLine" id="double-pendulum-flare-2" title="2">events time <span class="fu">=</span> <span class="dt">Flare</span><span class="fu">.</span>liftSF (<span class="dt">Signal</span><span class="fu">.</span>merge <span class="fu">$</span> <span class="dt">AnimationFrame</span> <span class="fu">&lt;$&gt;</span> time)</a>
<a class="sourceLine" id="double-pendulum-flare-3" title="3">                           (<span class="dt">Flare</span><span class="fu">.</span>button <span class="st">&quot;Play/Pause&quot;</span> <span class="dt">None</span> <span class="dt">TogglePlay</span>)</a></code></pre></div>
</div>
<p>In the <code>main</code> function we can obtain the animation signal, and pass it to <code>events</code>. Using <code>Flare.foldp</code> the series of <code>Msg</code> messages is converted into a series of <code>Model</code> objects. These are then rendered to a canvas in the <code>draw</code> function.</p>
<div class="annotated-code">
<p><span><em>«double-pendulum-flare»+</em></span></p>
<div class="sourceCode" id="double-pendulum-flare"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="double-pendulum-flare-1" title="1"><span class="ot">main </span><span class="fu">::</span> <span class="dt">Effect</span> <span class="dt">Unit</span></a>
<a class="sourceLine" id="double-pendulum-flare-2" title="2">main <span class="fu">=</span> do</a>
<a class="sourceLine" id="double-pendulum-flare-3" title="3">    time <span class="fu">&lt;-</span> animationFrame</a>
<a class="sourceLine" id="double-pendulum-flare-4" title="4">    <span class="kw">let</span> model <span class="fu">=</span> <span class="dt">Flare</span><span class="fu">.</span>foldp update initModel (events time)</a>
<a class="sourceLine" id="double-pendulum-flare-5" title="5">    runFlareDrawing <span class="st">&quot;double-pendulum-control&quot;</span> </a>
<a class="sourceLine" id="double-pendulum-flare-6" title="6">                    <span class="st">&quot;double-pendulum-output&quot;</span></a>
<a class="sourceLine" id="double-pendulum-flare-7" title="7">                    (draw <span class="fu">&lt;$&gt;</span> model)</a></code></pre></div>
</div>
<h2 id="drawing">Drawing</h2>
<div class="annotated-code">
<p><span><em>«double-pendulum-flare»+</em></span></p>
<div class="sourceCode" id="double-pendulum-flare"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="double-pendulum-flare-1" title="1"><span class="ot">draw </span><span class="fu">::</span> <span class="dt">Model</span> <span class="fu">-&gt;</span> <span class="dt">Drawing.Drawing</span></a>
<a class="sourceLine" id="double-pendulum-flare-2" title="2">draw { state<span class="fu">:</span>  { position<span class="fu">:</span> <span class="dt">Coordinates</span> q }</a>
<a class="sourceLine" id="double-pendulum-flare-3" title="3">     , params<span class="fu">:</span> { l1, l2, m1, m2 } } <span class="fu">=</span></a>
<a class="sourceLine" id="double-pendulum-flare-4" title="4">    <span class="kw">let</span> p1    <span class="fu">=</span> { x<span class="fu">:</span> l1 <span class="fu">*</span> (sin q<span class="fu">.</span>theta), y<span class="fu">:</span> l1 <span class="fu">*</span> (cos q<span class="fu">.</span>theta) }</a>
<a class="sourceLine" id="double-pendulum-flare-5" title="5">        p2    <span class="fu">=</span> { x<span class="fu">:</span> p1<span class="fu">.</span>x <span class="fu">+</span> l2 <span class="fu">*</span> (sin q<span class="fu">.</span>phi), y<span class="fu">:</span> p1<span class="fu">.</span>y <span class="fu">+</span> l2 <span class="fu">*</span> (cos q<span class="fu">.</span>phi) }</a>
<a class="sourceLine" id="double-pendulum-flare-6" title="6">        orig  <span class="fu">=</span> { x<span class="fu">:</span> <span class="dv">0.0</span>, y<span class="fu">:</span> <span class="dv">0.0</span> }</a>
<a class="sourceLine" id="double-pendulum-flare-7" title="7">        tr {x, y} <span class="fu">=</span> { x<span class="fu">:</span> x<span class="fu">*</span><span class="dv">100.0</span> <span class="fu">+</span> <span class="dv">300.0</span>, y<span class="fu">:</span> y<span class="fu">*</span><span class="dv">100.0</span> <span class="fu">+</span> <span class="dv">100.0</span> }</a>
<a class="sourceLine" id="double-pendulum-flare-8" title="8">        rods  <span class="fu">=</span> <span class="dt">Drawing</span><span class="fu">.</span>outlined </a>
<a class="sourceLine" id="double-pendulum-flare-9" title="9">                    (<span class="dt">Drawing</span><span class="fu">.</span>lineWidth <span class="dv">2.0</span> <span class="fu">&lt;&gt;</span> <span class="dt">Drawing</span><span class="fu">.</span>outlineColor (rgb&#39; <span class="dv">0.0</span> <span class="dv">0.0</span> <span class="dv">0.0</span>))</a>
<a class="sourceLine" id="double-pendulum-flare-10" title="10">                    (<span class="dt">Drawing</span><span class="fu">.</span>path <span class="fu">$</span> map tr [orig, p1, p2])</a>
<a class="sourceLine" id="double-pendulum-flare-11" title="11">        hinge <span class="fu">=</span> <span class="dt">Drawing</span><span class="fu">.</span>filled</a>
<a class="sourceLine" id="double-pendulum-flare-12" title="12">                    (<span class="dt">Drawing</span><span class="fu">.</span>fillColor (rgb&#39; <span class="dv">0.0</span> <span class="dv">0.0</span> <span class="dv">0.0</span>))</a>
<a class="sourceLine" id="double-pendulum-flare-13" title="13">                    (<span class="dt">Drawing</span><span class="fu">.</span>circle (tr orig)<span class="fu">.</span>x (tr orig)<span class="fu">.</span>y <span class="dv">3.0</span>)</a>
<a class="sourceLine" id="double-pendulum-flare-14" title="14">        mass1 <span class="fu">=</span> <span class="dt">Drawing</span><span class="fu">.</span>filled</a>
<a class="sourceLine" id="double-pendulum-flare-15" title="15">                    (<span class="dt">Drawing</span><span class="fu">.</span>fillColor (rgb&#39; <span class="dv">0.5</span> <span class="dv">0.0</span> <span class="dv">0.0</span>))</a>
<a class="sourceLine" id="double-pendulum-flare-16" title="16">                    (<span class="dt">Drawing</span><span class="fu">.</span>circle (tr p1)<span class="fu">.</span>x (tr p1)<span class="fu">.</span>y (m1 <span class="fu">*</span> <span class="dv">4.0</span>))</a>
<a class="sourceLine" id="double-pendulum-flare-17" title="17">        mass2 <span class="fu">=</span> <span class="dt">Drawing</span><span class="fu">.</span>filled</a>
<a class="sourceLine" id="double-pendulum-flare-18" title="18">                    (<span class="dt">Drawing</span><span class="fu">.</span>fillColor (rgb&#39; <span class="dv">0.5</span> <span class="dv">0.0</span> <span class="dv">0.0</span>))</a>
<a class="sourceLine" id="double-pendulum-flare-19" title="19">                    (<span class="dt">Drawing</span><span class="fu">.</span>circle (tr p2)<span class="fu">.</span>x (tr p2)<span class="fu">.</span>y (m2 <span class="fu">*</span> <span class="dv">4.0</span>))</a>
<a class="sourceLine" id="double-pendulum-flare-20" title="20">    in <span class="dt">Drawing</span><span class="fu">.</span>shadow (<span class="dt">Drawing</span><span class="fu">.</span>shadowOffset <span class="dv">2.0</span> <span class="dv">2.0</span> <span class="fu">&lt;&gt;</span> <span class="dt">Drawing</span><span class="fu">.</span>shadowBlur <span class="dv">4.0</span> <span class="fu">&lt;&gt;</span> <span class="dt">Drawing</span><span class="fu">.</span>shadowColor (rgb&#39; <span class="dv">0.5</span> <span class="dv">0.5</span> <span class="dv">0.5</span>))</a>
<a class="sourceLine" id="double-pendulum-flare-21" title="21">                      (rods <span class="fu">&lt;&gt;</span> hinge <span class="fu">&lt;&gt;</span> mass1 <span class="fu">&lt;&gt;</span> mass2)</a></code></pre></div>
</div>
<h2 id="main">Main</h2>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#double-pendulum-main" aria-controls="double-pendulum-main">
&lt;&lt;double-pendulum-main&gt;&gt;=
</button>
<div id="double-pendulum-main" class="collapse">
<div class="card" style="height: 20em">
<div class="overflow-auto">
<div class="annotated-code">
<p><span><em>«src/DoublePendulum.purs»=</em></span></p>
<div class="sourceCode" id="cb5" data-file="src/DoublePendulum.purs"><pre class="sourceCode pure"><code class="sourceCode pure"><a class="sourceLine" id="cb5-1" title="1">module <span class="dt">DoublePendulum</span> where</a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3">import <span class="dt">Prelude</span></a>
<a class="sourceLine" id="cb5-4" title="4">import <span class="dt">Effect</span> (<span class="dt">Effect</span>)</a>
<a class="sourceLine" id="cb5-5" title="5">import <span class="dt">Math</span> (pow, cos, sin, pi, (<span class="fu">%</span>))</a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7">import <span class="dt">Hamilton</span> ( <span class="dt">HamiltonianSystem</span>, <span class="dt">State</span>, leapFrog, haltAtTime, iterateSolution )</a>
<a class="sourceLine" id="cb5-8" title="8"></a>
<a class="sourceLine" id="cb5-9" title="9">import <span class="dt">Flare</span> as <span class="dt">Flare</span></a>
<a class="sourceLine" id="cb5-10" title="10">import <span class="dt">Flare.Drawing</span> (runFlareDrawing)</a>
<a class="sourceLine" id="cb5-11" title="11">import <span class="dt">Signal</span> as <span class="dt">Signal</span></a>
<a class="sourceLine" id="cb5-12" title="12">import <span class="dt">Signal.DOM</span> (animationFrame)</a>
<a class="sourceLine" id="cb5-13" title="13"></a>
<a class="sourceLine" id="cb5-14" title="14">import <span class="dt">Graphics.Drawing</span> as <span class="dt">Drawing</span></a>
<a class="sourceLine" id="cb5-15" title="15">import <span class="dt">Color</span> (rgb&#39;)</a>
<a class="sourceLine" id="cb5-16" title="16"></a>
<a class="sourceLine" id="cb5-17" title="17"><span class="fu">&lt;&lt;</span><span class="dt">double</span><span class="fu">-</span>pendulum<span class="fu">&gt;&gt;</span></a>
<a class="sourceLine" id="cb5-18" title="18"><span class="fu">&lt;&lt;</span><span class="dt">double</span><span class="fu">-</span>pendulum<span class="fu">-</span>animation<span class="fu">&gt;&gt;</span></a>
<a class="sourceLine" id="cb5-19" title="19"><span class="fu">&lt;&lt;</span><span class="dt">double</span><span class="fu">-</span>pendulum<span class="fu">-</span>flare<span class="fu">&gt;&gt;</span></a></code></pre></div>
</div>
</div>
</div>
</div>
<script type="text/javascript" src="js/double-pendulum.js"></script>
<p><br><br></p>
</div>

</main>

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script type="text/javascript" src="js/bootstrap.js"></script>
</body>
</html>
